#cloud-config
autoinstall:
  version: 1
  identity:
    hostname: ubuntu-dev
    password: "$6$rounds=4096$randomsalt$G8.2k5.0000000000000000000000000000000000000000000000000000000000000000000000000000000" # Change this! (Default: 1234, but hash is fake here for privacy, see below)
    realname: Ben Sivan
    username: bensiv
  locale: en_US.UTF-8
  keyboard:
    layout: us
  ssh:
    install-server: true
    authorized-keys: []
    allow-pw: true
  packages:
    - ansible
    - git
  
  late-commands:
    # 1. Mount the CIDATA partition to access Ansible files
    # We use explicit mount because cloud-init might have unmounted it or we need 'ansible' folder specifically
    - mkdir -p /mnt/cidata
    - mount -L CIDATA /mnt/cidata
    
    # 2. Copy the 'ansible' folder to the target system
    - cp -r /mnt/cidata/ansible /target/home/bensiv/ansible
    
    # 3. Fix permissions
    - curtin in-target --target=/target -- chown -R bensiv:bensiv /home/bensiv/ansible
    
    # 4. Run the Ansible playbook inside the target
    - curtin in-target --target=/target -- ansible-playbook /home/bensiv/ansible/site.yml

    # 5. Cleanup
    - umount /mnt/cidata
