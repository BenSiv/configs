#cloud-config
autoinstall:
  version: 1
  identity:
    hostname: ubuntu-dev
    password: "$6$rounds=4096$randomsalt$G8.2k5.0000000000000000000000000000000000000000000000000000000000000000000000000000000" # Change this! (Default: 1234, but hash is fake here for privacy, see below)
    realname: Ben Sivan
    username: bensiv
  locale: en_US.UTF-8
  keyboard:
    layout: us
  ssh:
    install-server: true
    authorized-keys: []
    allow-pw: true
  packages:
    - git

  
  late-commands:
    # 1. Mount the CIDATA partition to access Ansible files
    # We use explicit mount because cloud-init might have unmounted it or we need 'ansible' folder specifically
    - mkdir -p /mnt/cidata
    - mount -L CIDATA /mnt/cidata
    
    # 2. Copy the 'ansible' folder to the target system
    - cp -r /mnt/cidata/ansible /target/home/bensiv/ansible
    
    # 3. Fix permissions
    - curtin in-target --target=/target -- chown -R bensiv:bensiv /home/bensiv/ansible
    
    # 4. Bootstrap Ansible and Run (Robust Mode)
    # We attempt to install ansible. If it fails (no network), we proceed without crashing so the user can fix it later.
    - curtin in-target --target=/target -- bash -c "apt-get update && apt-get install -y software-properties-common && add-apt-repository -y universe && apt-get update && apt-get install -y ansible || echo 'WARNING: Failed to install Ansible. Check network.'"

    # 5. Run the Ansible playbook if available
    - curtin in-target --target=/target -- bash -c "if command -v ansible-playbook; then ansible-playbook /home/bensiv/ansible/site.yml; else echo 'SKIPPING: Ansible not found. Run ./install.sh manually after reboot.'; fi"

    # 6. Cleanup
    - umount /mnt/cidata
